---
layout: post
title: Back to the topic of speed
date: 2014-05-01 15:47:45.000000000 -05:00
categories: []
tags:
- arrays
- ruby map
- ruby-on-rails
status: publish
type: post
published: true
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
<p>I'm not very good with writing Ruby map methods - they just haven't quite sunk into my head.  It seems unnatural and awkward for me to think about creating arrays in this way.  </p>
<p>And these are the times in my life where I realize I'm staring at a wall that I need to overcome.  </p>
<p>So Stackoverflow - being the mecca of all things code-related in my opinion - allows me to post a question:</p>
<p> </p>
<p style="color:#000000;">How would you improve this:</p>
<pre class="lang-rb prettyprint prettyprinted" style="color:#000000;"><code><span class="pln" style="color:#000000;">time </span><span class="pun" style="color:#000000;">=</span><span class="typ" style="color:#2b91af;">Time</span><span class="pun" style="color:#000000;">.</span><span class="pln" style="color:#000000;">now
    </span><span class="lit" style="color:#800000;">@time</span><span class="pun" style="color:#000000;">=</span><span class="pun" style="color:#000000;">[]</span><span class="lit" style="color:#800000;">@time</span><span class="pun" style="color:#000000;">.</span><span class="pln" style="color:#000000;">push</span><span class="pun" style="color:#000000;">(</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">1.week</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">6.days</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">5.days</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">4.days</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">3.days</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">2.days</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">1.day</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">)</span><span class="pun" style="color:#000000;">)</span></code></pre>
<p style="color:#000000;">I'm trying out some of the suggestions below:</p>
<pre class="lang-rb prettyprint prettyprinted" style="color:#000000;"><code><span class="pln" style="color:#000000;">time </span><span class="pun" style="color:#000000;">=</span><span class="typ" style="color:#2b91af;">Time</span><span class="pun" style="color:#000000;">.</span><span class="pln" style="color:#000000;">now
    iterations </span><span class="pun" style="color:#000000;">=</span><span class="lit" style="color:#800000;">1000</span><span class="typ" style="color:#2b91af;">Benchmark</span><span class="pun" style="color:#000000;">.</span><span class="pln" style="color:#000000;">bm </span><span class="kwd" style="color:#00008b;">do</span><span class="pun" style="color:#000000;">|</span><span class="pln" style="color:#000000;">bm</span><span class="pun" style="color:#000000;">|</span><span class="pln" style="color:#000000;">
      bm</span><span class="pun" style="color:#000000;">.</span><span class="pln" style="color:#000000;">report </span><span class="kwd" style="color:#00008b;">do</span><span class="pln" style="color:#000000;">
         iterations</span><span class="pun" style="color:#000000;">.</span><span class="pln" style="color:#000000;">times </span><span class="kwd" style="color:#00008b;">do</span><span class="lit" style="color:#800000;">@time</span><span class="pun" style="color:#000000;">=</span><span class="lit" style="color:#800000;">7.downto</span><span class="pun" style="color:#000000;">(</span><span class="lit" style="color:#800000;">0</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">map </span><span class="pun" style="color:#000000;">{</span><span class="pun" style="color:#000000;">|</span><span class="pln" style="color:#000000;">v</span><span class="pun" style="color:#000000;">|</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time </span><span class="pun" style="color:#000000;">-</span><span class="pln" style="color:#000000;"> v</span><span class="pun" style="color:#000000;">.</span><span class="pln" style="color:#000000;">days</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">)</span><span class="pun" style="color:#000000;">}</span><span class="kwd" style="color:#00008b;">end</span><span class="kwd" style="color:#00008b;">end</span><span class="pln" style="color:#000000;">
      bm</span><span class="pun" style="color:#000000;">.</span><span class="pln" style="color:#000000;">report </span><span class="kwd" style="color:#00008b;">do</span><span class="pln" style="color:#000000;">
       iterations</span><span class="pun" style="color:#000000;">.</span><span class="pln" style="color:#000000;">times </span><span class="kwd" style="color:#00008b;">do</span><span class="lit" style="color:#800000;">@time</span><span class="pun" style="color:#000000;">=</span><span class="pun" style="color:#000000;">[]</span><span class="lit" style="color:#800000;">@time</span><span class="pun" style="color:#000000;">.</span><span class="pln" style="color:#000000;">push</span><span class="pun" style="color:#000000;">(</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">1.week</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">6.days</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">5.days</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">4.days</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">3.days</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">2.days</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">-</span><span class="lit" style="color:#800000;">1.day</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">),</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">)</span><span class="pun" style="color:#000000;">)</span><span class="kwd" style="color:#00008b;">end</span><span class="kwd" style="color:#00008b;">end</span><span class="kwd" style="color:#00008b;">end</span><span class="pln" style="color:#000000;">

       user     system      total        real<br />
   </span><span class="lit" style="color:#800000;">0.350000 </span><span class="lit" style="color:#800000;">0.960000 </span><span class="lit" style="color:#800000;">1.310000 </span><span class="pun" style="color:#000000;">(</span><span class="lit" style="color:#800000;">1.310054</span><span class="pun" style="color:#000000;">)<br /></span><span class="lit" style="color:#800000;">   0.310000 </span><span class="lit" style="color:#800000;">0.840000 </span><span class="lit" style="color:#800000;">1.150000 </span><span class="pun" style="color:#000000;">(</span><span class="lit" style="color:#800000;">1.156484</span><span class="pun" style="color:#000000;">)</span></code></pre>
<p style="color:#000000;">downto is demonstrably slower than my method.</p>
<p style="color:#000000;">The next test used the method:</p>
<pre class="lang-rb prettyprint prettyprinted" style="color:#000000;"><code><span class="lit" style="color:#800000;">@time</span><span class="pun" style="color:#000000;">=</span><span class="pun" style="color:#000000;">(</span><span class="lit" style="color:#800000;">0.</span><span class="pun" style="color:#000000;">.</span><span class="lit" style="color:#800000;">7</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">map </span><span class="pun" style="color:#000000;">{</span><span class="pun" style="color:#000000;">|</span><span class="pln" style="color:#000000;">x</span><span class="pun" style="color:#000000;">|</span><span class="pun" style="color:#000000;">(</span><span class="pln" style="color:#000000;">time </span><span class="pun" style="color:#000000;">-</span><span class="pln" style="color:#000000;"> x</span><span class="pun" style="color:#000000;">.</span><span class="pln" style="color:#000000;">days</span><span class="pun" style="color:#000000;">).</span><span class="pln" style="color:#000000;">strftime</span><span class="pun" style="color:#000000;">(</span><span class="str" style="color:#800000;">"%m-%d"</span><span class="pun" style="color:#000000;">)</span><span class="pun" style="color:#000000;">}.</span><span class="pln" style="color:#000000;">reverse</span></code></pre>
<p style="color:#000000;">1000 iterations</p>
<pre class="lang-rb prettyprint prettyprinted" style="color:#000000;"><code><span class="pln" style="color:#000000;">       user     system      total        real
   </span><span class="lit" style="color:#800000;">0.340000 </span><span class="lit" style="color:#800000;">0.980000 </span><span class="lit" style="color:#800000;">1.320000 </span><span class="pun" style="color:#000000;">(</span><span class="lit" style="color:#800000;">1.321518</span><span class="pun" style="color:#000000;">)<br /></span><span class="lit" style="color:#800000;">   0.300000 </span><span class="lit" style="color:#800000;">0.840000 </span><span class="lit" style="color:#800000;">1.140000 </span><span class="pun" style="color:#000000;">(</span><span class="lit" style="color:#800000;">1.149759</span><span class="pun" style="color:#000000;">)</span></code></pre>
<p style="color:#000000;">5000 iterations</p>
<pre class="lang-rb prettyprint prettyprinted" style="color:#000000;"><code><span class="pln" style="color:#000000;">       user     system      total        real
   <br /></span><span class="lit" style="color:#800000;">1.720000 </span><span class="lit" style="color:#800000;">4.800000 </span><span class="lit" style="color:#800000;">6.520000 </span><span class="pun" style="color:#000000;">(</span><span class="lit" style="color:#800000;">6.545335</span><span class="pun" style="color:#000000;">)<br /></span><span class="lit" style="color:#800000;">1.530000 </span><span class="lit" style="color:#800000;">4.180000 </span><span class="lit" style="color:#800000;">5.710000 </span><span class="pun" style="color:#000000;">(</span><span class="lit" style="color:#800000;">5.712035</span><span class="pun" style="color:#000000;">)</span></code></pre>
<p style="color:#000000;">I'm having a hard time wrapping my head around this without looking at both downto and map in the Ruby core, but in both cases my more elongated method of writing this responds faster than the more simplified methods (I like the answers below much more from a readability standpoint). Please shed some light on my tests if I'm doing it wrong. I expected map to blow my way out of the water.</p>
<p style="color:#000000;">UPDATED FOR STEFAN'S ANSWER</p>
<p style="color:#000000;">So I see Stefan's answer below and throw it in the tester:</p>
<pre class="lang-rb prettyprint prettyprinted" style="color:#000000;"><code><span class="pln" style="color:#000000;">       user     system      total        real<br />
   </span><span class="lit" style="color:#800000;">0.040000 </span><span class="lit" style="color:#800000;">0.000000 </span><span class="lit" style="color:#800000;">0.040000 </span><span class="pun" style="color:#000000;">(</span><span class="lit" style="color:#800000;">0.035976</span><span class="pun" style="color:#000000;">)<br /></span><span class="lit" style="color:#800000;">   1.520000 </span><span class="lit" style="color:#800000;">4.180000 </span><span class="lit" style="color:#800000;">5.700000 </span><span class="pun" style="color:#000000;">(</span><span class="lit" style="color:#800000;">5.704401</span><span class="pun" style="color:#000000;">)</span></code></pre>
<p style="color:#000000;">Holy crap! 5000 iterations and it absolutely destroys my method.</p>
<p style="color:#000000;">Because he accurately points out that I'm only interested in Dates, I decide to change my own method from Time.now to Date.today and test it:</p>
<pre><code><span class="pln" style="color:#000000;">       user     system      total        real
</span></code></pre>
<pre><code><span class="lit" style="color:#800000;">0.090000 </span><span class="lit" style="color:#800000;">0.000000 </span><span class="lit" style="color:#800000;">0.090000 </span><span class="pun" style="color:#000000;">(</span><span class="lit" style="color:#800000;">0.085940</span><span class="pun" style="color:#000000;">)<br /></span><span class="lit" style="color:#800000;">   0.390000 </span><span class="lit" style="color:#800000;">0.000000 </span><span class="lit" style="color:#800000;">0.390000 </span><span class="pun" style="color:#000000;">(</span><span class="lit" style="color:#800000;">0.398143</span><span class="pun" style="color:#000000;">)</span></code></pre>
<p style="color:#000000;">It's somewhat weird that in the first test Stefan's method clocks in at 0.0359 and in the second clocks at 0.0859, more than double, but it's still hundredths of a second over 5000 iterations - so I think I'm deep into splitting hairs territory here.</p>
<p style="color:#000000;"><a href="http://stackoverflow.com/questions/23402482/how-do-i-simplify-pushing-multiple-values-into-an-array-in-ruby">See the original Stackoverflow thread here</a></p>
<p style="color:#000000;"> </p>
<p style="color:#000000;"> </p>
